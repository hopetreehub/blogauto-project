#!/usr/bin/env python3
"""
ì „ë¬¸ê°€ í˜ë¥´ì†Œë‚˜ UI/UX í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
- í¬ë¡œë¯¸ì›€ ë¸Œë¼ìš°ì €ë¡œ ì‹¤ì œ ì‚¬ìš©ì ê´€ì ì—ì„œ í…ŒìŠ¤íŠ¸
- ë””ìì¸, ê¸°ëŠ¥ì„±, ì‚¬ìš©ì„± ì¢…í•© ê²€ì¦
"""

import subprocess
import time
import json
import os
from datetime import datetime

class ExpertUITester:
    def __init__(self):
        self.test_results = {
            "timestamp": datetime.now().isoformat(),
            "frontend_url": "http://localhost:4007",
            "backend_url": "http://localhost:8000",
            "tests": {},
            "issues": [],
            "recommendations": []
        }
        
    def run_chromium_test(self, url, test_name, js_commands=None):
        """í¬ë¡œë¯¸ì›€ìœ¼ë¡œ ì‹¤ì œ ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸ ì‹¤í–‰"""
        try:
            # í¬ë¡œë¯¸ì›€ ëª…ë ¹ì–´ ì¤€ë¹„
            chromium_cmd = [
                'chromium-browser',
                '--headless',
                '--disable-gpu',
                '--no-sandbox',
                '--disable-web-security',
                '--dump-dom',
                '--virtual-time-budget=10000',
                url
            ]
            
            # í¬ë¡œë¯¸ì›€ ì‹¤í–‰
            result = subprocess.run(chromium_cmd, capture_output=True, text=True, timeout=30)
            
            if result.returncode == 0:
                dom_content = result.stdout
                self.test_results["tests"][test_name] = {
                    "status": "success",
                    "dom_length": len(dom_content),
                    "has_content": len(dom_content) > 1000,
                    "timestamp": datetime.now().isoformat()
                }
                return dom_content
            else:
                self.test_results["tests"][test_name] = {
                    "status": "failed",
                    "error": result.stderr,
                    "timestamp": datetime.now().isoformat()
                }
                return None
                
        except Exception as e:
            self.test_results["tests"][test_name] = {
                "status": "error",
                "error": str(e),
                "timestamp": datetime.now().isoformat()
            }
            return None
    
    def analyze_html_structure(self, html_content, page_name):
        """HTML êµ¬ì¡° ë° ë””ìì¸ ìš”ì†Œ ë¶„ì„"""
        analysis = {
            "has_html": "<html" in html_content,
            "has_head": "<head" in html_content,
            "has_body": "<body" in html_content,
            "has_navigation": any(nav in html_content.lower() for nav in ["<nav", "navigation", "menu"]),
            "has_main_content": "<main" in html_content or "main" in html_content,
            "has_footer": "<footer" in html_content,
            "has_css": any(css in html_content for css in ["<style", ".css", "stylesheet"]),
            "has_js": any(js in html_content for js in ["<script", ".js"]),
            "responsive_indicators": any(resp in html_content for resp in ["viewport", "responsive", "mobile"]),
            "accessibility_features": any(acc in html_content for acc in ["aria-", "alt=", "role="]),
            "form_elements": any(form in html_content for form in ["<form", "<input", "<button"]),
            "error_indicators": any(err in html_content.lower() for err in ["error", "404", "500", "failed"])
        }
        
        # ë¬¸ì œì  ì‹ë³„
        issues = []
        if not analysis["has_html"]:
            issues.append(f"{page_name}: HTML êµ¬ì¡° ëˆ„ë½")
        if not analysis["has_navigation"]:
            issues.append(f"{page_name}: ë„¤ë¹„ê²Œì´ì…˜ ìš”ì†Œ ëˆ„ë½")
        if analysis["error_indicators"]:
            issues.append(f"{page_name}: ì—ëŸ¬ í‘œì‹œ ê°ì§€")
        if not analysis["responsive_indicators"]:
            issues.append(f"{page_name}: ë°˜ì‘í˜• ë””ìì¸ í‘œì‹œ ëˆ„ë½")
        if not analysis["accessibility_features"]:
            issues.append(f"{page_name}: ì ‘ê·¼ì„± ê¸°ëŠ¥ ë¶€ì¡±")
            
        self.test_results["issues"].extend(issues)
        return analysis
    
    def test_main_pages(self):
        """ì£¼ìš” í˜ì´ì§€ë“¤ í…ŒìŠ¤íŠ¸"""
        pages_to_test = [
            ("í™ˆí˜ì´ì§€", "http://localhost:4007/"),
            ("ì½˜í…ì¸  ìƒì„±", "http://localhost:4007/content"),
            ("ì œëª© ìƒì„±", "http://localhost:4007/titles"),
            ("í‚¤ì›Œë“œ ë¶„ì„", "http://localhost:4007/keywords"),
            ("ì´ë¯¸ì§€ ìƒì„±", "http://localhost:4007/images"),
            ("ì„¤ì •", "http://localhost:4007/settings"),
            ("WordPress", "http://localhost:4007/wordpress")
        ]
        
        for page_name, url in pages_to_test:
            print(f"ğŸ” {page_name} í…ŒìŠ¤íŠ¸ ì¤‘...")
            html_content = self.run_chromium_test(url, f"page_{page_name}")
            
            if html_content:
                analysis = self.analyze_html_structure(html_content, page_name)
                self.test_results["tests"][f"analysis_{page_name}"] = analysis
                print(f"âœ… {page_name} ë¶„ì„ ì™„ë£Œ")
            else:
                print(f"âŒ {page_name} í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨")
                
            time.sleep(2)  # ì„œë²„ ë¶€í•˜ ë°©ì§€
    
    def test_api_endpoints(self):
        """ë°±ì—”ë“œ API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸"""
        import requests
        
        api_endpoints = [
            ("Health Check", "GET", "/"),
            ("API ì •ë³´", "GET", "/api/info"),
            ("í‚¤ì›Œë“œ ë¶„ì„", "POST", "/api/keywords/analyze"),
            ("ì œëª© ìƒì„±", "POST", "/api/titles/generate"),
            ("ì½˜í…ì¸  ìƒì„±", "POST", "/api/content/generate")
        ]
        
        for name, method, endpoint in api_endpoints:
            try:
                url = f"http://localhost:8000{endpoint}"
                if method == "GET":
                    response = requests.get(url, timeout=10)
                else:
                    # POST ìš”ì²­ì„ ìœ„í•œ ë”ë¯¸ ë°ì´í„°
                    data = {"keyword": "test", "title": "test"}
                    response = requests.post(url, json=data, timeout=10)
                
                self.test_results["tests"][f"api_{name}"] = {
                    "status_code": response.status_code,
                    "response_time": response.elapsed.total_seconds(),
                    "has_response": len(response.text) > 0,
                    "timestamp": datetime.now().isoformat()
                }
                
                print(f"ğŸ”— API {name}: {response.status_code}")
                
            except Exception as e:
                self.test_results["tests"][f"api_{name}"] = {
                    "error": str(e),
                    "timestamp": datetime.now().isoformat()
                }
                print(f"âŒ API {name} ì˜¤ë¥˜: {str(e)}")
    
    def generate_expert_recommendations(self):
        """ì „ë¬¸ê°€ ê´€ì ì—ì„œ ê°œì„  ê¶Œê³ ì‚¬í•­ ìƒì„±"""
        recommendations = []
        
        # UI/UX ê°œì„ ì‚¬í•­
        if len(self.test_results["issues"]) > 0:
            recommendations.append("ğŸ¨ UI/UX ê°œì„ : " + ", ".join(self.test_results["issues"][:3]))
        
        # ì„±ëŠ¥ ê°œì„ ì‚¬í•­
        slow_apis = [name for name, data in self.test_results["tests"].items() 
                    if "api_" in name and data.get("response_time", 0) > 5]
        if slow_apis:
            recommendations.append(f"âš¡ ì„±ëŠ¥ ìµœì í™”: {', '.join(slow_apis)} API ì‘ë‹µì‹œê°„ ê°œì„  í•„ìš”")
        
        # ì ‘ê·¼ì„± ê°œì„ ì‚¬í•­
        recommendations.append("â™¿ ì ‘ê·¼ì„± ê°•í™”: ARIA ë¼ë²¨, í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜, ëŒ€ì²´ í…ìŠ¤íŠ¸ ì¶”ê°€")
        
        # ë³´ì•ˆ ê°œì„ ì‚¬í•­
        recommendations.append("ğŸ›¡ï¸ ë³´ì•ˆ ê°•í™”: API í‚¤ ê²€ì¦, ì…ë ¥ê°’ sanitization, HTTPS ì ìš©")
        
        # ì‚¬ìš©ì ê²½í—˜ ê°œì„ 
        recommendations.append("ğŸ‘¤ UX ê°œì„ : ë¡œë”© ìƒíƒœ í‘œì‹œ, ì—ëŸ¬ ë©”ì‹œì§€ ê°œì„ , ì§„í–‰ë¥  í‘œì‹œ")
        
        self.test_results["recommendations"] = recommendations
    
    def run_comprehensive_test(self):
        """ì¢…í•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰"""
        print("ğŸš€ ì „ë¬¸ê°€ í˜ë¥´ì†Œë‚˜ UI/UX ì¢…í•© í…ŒìŠ¤íŠ¸ ì‹œì‘")
        print("=" * 60)
        
        # 1. ì„œë²„ ìƒíƒœ í™•ì¸
        print("1ï¸âƒ£ ì„œë²„ ìƒíƒœ í™•ì¸...")
        
        # 2. ë©”ì¸ í˜ì´ì§€ë“¤ í…ŒìŠ¤íŠ¸
        print("2ï¸âƒ£ ì£¼ìš” í˜ì´ì§€ í…ŒìŠ¤íŠ¸...")
        self.test_main_pages()
        
        # 3. API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
        print("3ï¸âƒ£ API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸...")
        self.test_api_endpoints()
        
        # 4. ì „ë¬¸ê°€ ê¶Œê³ ì‚¬í•­ ìƒì„±
        print("4ï¸âƒ£ ì „ë¬¸ê°€ ë¶„ì„ ë° ê¶Œê³ ì‚¬í•­ ìƒì„±...")
        self.generate_expert_recommendations()
        
        # 5. ê²°ê³¼ ì €ì¥
        report_file = f"expert_ui_test_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(report_file, 'w', encoding='utf-8') as f:
            json.dump(self.test_results, f, ensure_ascii=False, indent=2)
        
        print("=" * 60)
        print(f"ğŸ“Š í…ŒìŠ¤íŠ¸ ì™„ë£Œ! ë³´ê³ ì„œ: {report_file}")
        
        return self.test_results

if __name__ == "__main__":
    tester = ExpertUITester()
    results = tester.run_comprehensive_test()
    
    # ìš”ì•½ ì¶œë ¥
    print("\nğŸ“‹ í…ŒìŠ¤íŠ¸ ìš”ì•½:")
    print(f"ì´ í…ŒìŠ¤íŠ¸: {len(results['tests'])}")
    print(f"ë°œê²¬ëœ ì´ìŠˆ: {len(results['issues'])}")
    print(f"ê¶Œê³ ì‚¬í•­: {len(results['recommendations'])}")
    
    if results['issues']:
        print("\nâš ï¸ ì£¼ìš” ì´ìŠˆ:")
        for issue in results['issues'][:5]:
            print(f"  - {issue}")
    
    if results['recommendations']:
        print("\nğŸ’¡ ê°œì„  ê¶Œê³ ì‚¬í•­:")
        for rec in results['recommendations']:
            print(f"  - {rec}")